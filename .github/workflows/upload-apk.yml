name: Sync APK Data to GitHub

on:
  workflow_dispatch:
  schedule:
    # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡Gitee Releaseæ›´æ–°
    - cron: '*/5 * * * *'

env:
  GITEE_OWNER: ${{ secrets.GITEE_OWNER }}
  GITEE_REPO: ${{ secrets.GITEE_REPO }}
  GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-apk-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check secrets
        run: |
          if [ -z "$GITEE_TOKEN" ] || [ -z "$GITEE_OWNER" ] || [ -z "$GITEE_REPO" ] || [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ Missing required secrets: GITEE_TOKEN, GITEE_OWNER, GITEE_REPO, GITHUB_TOKEN"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          echo "ğŸ”§ Setting up Git configuration..."
          
          # é…ç½®Git
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          echo "âœ… Git configuration completed"

      - name: Ensure Gitee Release
        run: |
          echo "ğŸ” Ensuring v0.0.1 Release exists..."
          
          # æ£€æŸ¥v0.0.1 releaseæ˜¯å¦å­˜åœ¨
          RELEASE_EXISTS=$(curl -s -H "Authorization: token $GITEE_TOKEN" \
            "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases/tags/v0.0.1" | jq -r '.id // empty')
          
          if [ -z "$RELEASE_EXISTS" ]; then
            echo "ğŸ“¦ Creating v0.0.1 Release..."
            curl -s -X POST \
              -H "Authorization: token $GITEE_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "tag_name": "v0.0.1",
                "name": "APK Collection v0.0.1",
                "body": "APK Collection Release v0.0.1\nCreated by GitHub Actions",
                "prerelease": false
              }' \
              "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases"
            echo "âœ… v0.0.1 Release created"
          else
            echo "âœ… v0.0.1 Release already exists"
          fi

      - name: Sync APK Data to GitHub apk-data-only Branch
        run: |
          echo "ğŸ“ Syncing APK data from Gitee to GitHub apk-data-only branch..."
          
          # è·å–Gitee Releaseçš„assetsä¿¡æ¯
          RELEASE_DATA=$(curl -s -H "Authorization: token $GITEE_TOKEN" \
            "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases/tags/v0.0.1")
          
          RELEASE_ID=$(echo "$RELEASE_DATA" | jq -r '.id')
          echo "ğŸ“‹ Found Release ID: $RELEASE_ID"
          
          # è·å–Releaseçš„è¯¦ç»†ä¿¡æ¯å’Œassets
          ASSETS_DATA=$(curl -s -H "Authorization: token $GITEE_TOKEN" \
            "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases/$RELEASE_ID")
          
          # æå–assetsä¿¡æ¯å¹¶ç”ŸæˆAPKæ•°æ®
          APK_DATA=$(echo "$ASSETS_DATA" | jq -r '
            .assets | map({
              name: .name | split(".")[0],
              icon: "https://s2.loli.net/2025/09/05/sHNmMYuk4yB3jr9.jpg",
              category: (if (.name | test("game|Game")) then "Games"
                       elif (.name | test("music|Music")) then "Music"
                       elif (.name | test("video|Video")) then "Video"
                       elif (.name | test("photo|Photo|camera|Camera")) then "Photography"
                       elif (.name | test("social|Social|chat|Chat")) then "Social"
                       elif (.name | test("tool|Tool|util|Util")) then "Tools"
                       else "Other" end),
              downloadUrl: .browser_download_url
            })
          ')
          
          echo "ğŸ“Š Generated APK data:"
          echo "$APK_DATA" | jq .
          
          # åˆ›å»ºæˆ–æ›´æ–°apkData.jsonæ–‡ä»¶
          echo "$APK_DATA" > apkData.json
          
          # ç¡®ä¿apk-data-onlyåˆ†æ”¯å­˜åœ¨
          git checkout -B apk-data-only || git checkout apk-data-only
          
          # æ·»åŠ å¹¶æäº¤æ›´æ”¹
          git add apkData.json
          git commit -m "Update APK data from Gitee Release v0.0.1 - $(date)" || echo "No changes to commit"
          
          # æ¨é€åˆ°GitHubçš„apk-data-onlyåˆ†æ”¯
          git push https://$GITHUB_TOKEN@github.com/${{ github.repository }}.git apk-data-only
          
          echo "âœ… APK data synced to GitHub apk-data-only branch"

      - name: Summary
        run: |
          echo "ğŸ‰ Sync completed successfully!"
          echo "ğŸ“Š Summary:"
          echo "  - Gitee Repository: $GITEE_OWNER/$GITEE_REPO"
          echo "  - Gitee Release: v0.0.1 (source)"
          echo "  - GitHub Branch: apk-data-only (target - updated)"
          echo "  - APK Data: Synced from Gitee Release assets to GitHub"
          echo "  - Repository: ${{ github.repository }}"
          echo "  - Time: $(date)"
