name: Sync APK Data to GitHub

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

env:
  GITEE_OWNER: ${{ secrets.GITEE_OWNER }}
  GITEE_REPO: ${{ secrets.GITEE_REPO }}
  GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-apk-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Sync APK Data
        run: |
          # 配置Git
          git config --global user.name "FunEnn"
          git config --global user.email "3095852337@qq.com"
          
          # 获取Gitee Release assets
          ASSETS_DATA=$(curl -s -H "Authorization: token $GITEE_TOKEN" \
            "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases/tags/v0.0.1")
          
          # 生成APK数据（只保留APK文件）
          APK_DATA=$(echo "$ASSETS_DATA" | jq -r '
            .assets | 
            map(select(.name | test("\\.apk$"; "i"))) |
            map({
              name: .name | split(".")[0],
              icon: "https://s2.loli.net/2025/09/05/sHNmMYuk4yB3jr9.jpg",
              category: (if (.name | test("game|Game")) then "Games"
                       elif (.name | test("music|Music")) then "Music"
                       elif (.name | test("video|Video")) then "Video"
                       elif (.name | test("photo|Photo|camera|Camera")) then "Photography"
                       elif (.name | test("social|Social|chat|Chat")) then "Social"
                       elif (.name | test("tool|Tool|util|Util")) then "Tools"
                       else "Other" end),
              downloadUrl: .browser_download_url
            })
          ')
          
          # 创建目录和文件
          mkdir -p apk-data
          echo "$APK_DATA" > apk-data/apkData.json
          
          # 切换到master分支并推送
          git checkout master
          git pull origin master || true
          git add apk-data/apkData.json
          
          # 检查是否有变更
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update APK data - $(date)"
            git push origin master
            echo "✅ APK data synced and pushed successfully"
            
            # 触发部署工作流
            echo "🚀 Triggering deployment workflow..."
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"event_type": "deploy-apk-data"}' \
              "https://api.github.com/repos/${{ github.repository }}/dispatches"
          fi
          
          echo "✅ APK data sync completed"
